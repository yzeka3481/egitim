<!doctype html>
<html lang="tr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gezi Planlayƒ±cƒ±</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --border: rgba(255, 255, 255, .1);
      --text: #f8fafc;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --accent-glow: rgba(56, 189, 248, .2);
      --danger: #ef4444;
      --success: #10b981;
      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden
    }

    .app {
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100%;
      max-width: 1400px;
      margin: 0 auto
    }

    .header {
      padding: 12px 16px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .header h1 {
      font-size: 16px;
      margin: 0;
      font-weight: 600;
      letter-spacing: -.5px
    }

    .badge {
      font-size: 11px;
      background: rgba(255, 255, 255, .05);
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid var(--border)
    }

    .main {
      display: grid;
      grid-template-columns: 350px 1fr 300px;
      height: 100%;
      overflow: hidden
    }

    @media(max-width:1024px) {
      .main {
        grid-template-columns: 300px 1fr 0;
        transform: translateX(0);
        transition: transform .3s
      }
    }

    @media(max-width:768px) {
      .header h1 {
        font-size: 14px
      }

      .main {
        display: block;
        overflow: auto
      }

      .col {
        height: auto !important;
        border-right: 0 !important
      }
    }

    .col {
      background: var(--bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      position: relative
    }

    .col-head {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(255, 255, 255, .02);
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .col-head h2 {
      font-size: 13px;
      font-weight: 600;
      margin: 0;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .5px
    }

    .col-body {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    .btn {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px
    }

    .btn:hover {
      background: rgba(255, 255, 255, .05);
      border-color: rgba(255, 255, 255, .2)
    }

    .btn.primary {
      background: rgba(56, 189, 248, .15);
      border-color: rgba(56, 189, 248, .3);
      color: #7dd3fc
    }

    .btn.primary:hover {
      background: rgba(56, 189, 248, .25);
      box-shadow: 0 0 10px var(--accent-glow)
    }

    .btn.danger {
      background: rgba(239, 68, 68, .15);
      border-color: rgba(239, 68, 68, .3);
      color: #fca5a5
    }

    .icon-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 6px
    }

    .input {
      background: rgba(0, 0, 0, .2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px;
      border-radius: 8px;
      width: 100%;
      font-size: 12px
    }

    .input:focus {
      outline: none;
      border-color: var(--accent)
    }

    .select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 16px
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      display: flex;
      gap: 10px;
      transition: border-color .2s
    }

    .card:hover {
      border-color: rgba(255, 255, 255, .2)
    }

    .card h3 {
      margin: 0 0 4px 0;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .card .meta {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      gap: 8px
    }

    .check {
      width: 16px;
      height: 16px;
      margin: 2px 0 0 0;
      accent-color: var(--accent);
      cursor: pointer
    }

    .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(255, 255, 255, .05);
      color: var(--muted)
    }

    #map {
      width: 100%;
      height: 100%;
      background: #0f172a
    }

    /* Upload Zone */
    .dropzone {
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: rgba(0, 0, 0, .1);
      transition: all .2s;
      cursor: pointer
    }

    .dropzone:hover {
      border-color: var(--accent);
      background: rgba(56, 189, 248, .05)
    }

    .dropzone p {
      margin: 0;
      font-size: 12px;
      color: var(--muted)
    }

    /* Itinerary */
    .it-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 6px
    }

    .it-item strong {
      font-size: 12px;
      display: block
    }

    .sort-controls {
      display: flex;
      gap: 2px
    }

    /* Stats */
    .stats {
      padding: 12px;
      background: var(--panel);
      border-top: 1px solid var(--border)
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px
    }

    .kpi {
      background: rgba(0, 0, 0, .2);
      padding: 8px;
      border-radius: 6px;
      font-size: 11px;
      color: var(--muted);
      text-align: center
    }

    .kpi b {
      display: block;
      font-size: 16px;
      color: var(--accent);
      margin-bottom: 2px
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(2px)
    }

    .modal-overlay.open {
      display: flex
    }

    .modal {
      background: #1e293b;
      width: 90%;
      max-width: 600px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 40px rgba(0, 0, 0, .5);
      overflow: hidden;
      animation: slideUp .2s ease-out
    }

    .modal-head {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .modal-head h3 {
      margin: 0;
      font-size: 15px;
      color: var(--text)
    }

    .modal-body {
      padding: 16px;
      display: grid;
      gap: 12px
    }

    .textarea {
      background: rgba(0, 0, 0, .2);
      border: 1px solid var(--border);
      color: var(--text);
      width: 100%;
      min-height: 150px;
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      resize: vertical;
      border-radius: 8px
    }

    /* Mobile Nav */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1e293b;
      border-top: 1px solid var(--border);
      padding: 10px;
      justify-content: space-around;
      z-index: 1000
    }

    @media(max-width:768px) {
      .mobile-nav {
        display: flex
      }

      .col {
        padding-bottom: 70px
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    /* Utility */
    .d-none {
      display: none !important
    }
  </style>
</head>

<body>

  <div class="app">
    <div class="header">
      <div style="display:flex;align-items:center;gap:10px">
        <h1>üåç Gezi Planlayƒ±cƒ±</h1>
        <span class="badge" id="cityBadge">≈ûehir Se√ßilmedi</span>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn primary" onclick="document.getElementById('fileNew').click()">+ Yeni Y√ºkle</button>
        <input type="file" id="fileNew" accept=".kml,.kmz" multiple hidden
          onchange="handleFileSelect(this.files, true)">
        <button class="btn" onclick="openImportModal()">üîó Link/KML</button>
      </div>
    </div>

    <div class="main" id="mainContainer">
      <!-- Panel 1: List -->
      <div class="col" id="colList">
        <div class="col-head">
          <h2>Yerler</h2>
          <div style="display:flex;gap:6px">
            <input class="input" id="search" placeholder="Ara..." style="width:120px">
            <button class="btn icon-btn danger" onclick="deleteActiveCity()" title="≈ûehri Sil">üóë</button>
          </div>
        </div>
        <div class="col-body">
          <select id="citySelect" class="input select" onchange="changeCity()"></select>
          <div id="list" style="display:grid;gap:8px"></div>
          <div class="dropzone" id="dropzone" onclick="document.getElementById('fileNew').click()">
            <p>KML/KMZ Dosyalarƒ±nƒ± S√ºr√ºkleyin<br>veya Tƒ±klayƒ±n</p>
          </div>
        </div>
      </div>

      <!-- Panel 2: Map -->
      <div class="col" id="colMap" style="padding:0">
        <div id="map"></div>
      </div>

      <!-- Panel 3: Itinerary -->
      <div class="col" id="colRoute">
        <div class="col-head">
          <h2>Rota</h2>
          <select id="travelMode" class="input select" style="width:auto;height:24px;padding:2px 6px"
            onchange="updateRouteMode()">
            <option value="walking">üö∂ Y√ºr√ºy√º≈ü</option>
            <option value="driving">üöó Araba</option>
            <option value="transit">üöå Toplu Ta≈üƒ±ma</option>
            <option value="bicycling">üö≤ Bisiklet</option>
          </select>
        </div>
        <div class="col-body" id="itinerary"></div>
        <div class="stats">
          <div class="kpi-grid">
            <div class="kpi"><b id="kpiKm">-</b>km</div>
            <div class="kpi"><b id="kpiMin">-</b>dk</div>
          </div>
          <button class="btn primary" style="width:100%" onclick="computeRoute()" id="btnCompute">Hesapla</button>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" style="flex:1" onclick="openGoogleMaps()">Maps'te A√ß</button>
            <button class="btn danger" onclick="clearRoute()">Temizle</button>
          </div>
          <p id="statsMsg" style="font-size:10px;color:var(--muted);text-align:center;margin:8px 0 0 0"></p>
        </div>
      </div>
    </div>

    <div class="mobile-nav">
      <button class="btn" onclick="showTab('colList')">Liste</button>
      <button class="btn" onclick="showTab('colMap')">Harita</button>
      <button class="btn" onclick="showTab('colRoute')">Rota</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="importModal">
    <div class="modal">
      <div class="modal-head">
        <h3>KML / MyMaps Ekle</h3>
        <button class="btn icon-btn" onclick="closeImportModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div style="display:flex;gap:8px">
          <input class="input" id="urlInput" placeholder="Google My Maps Payla≈üƒ±m Linki veya KML URL">
          <button class="btn primary" onclick="fetchFromUrl()" id="btnFetch">Getir</button>
        </div>
        <p style="font-size:11px;color:var(--muted);margin:0">
          Google My Maps i√ßin: Harita > Payla≈ü > "Baƒülantƒ±sƒ± olan herkes" > Linki kopyala yapƒ±≈ütƒ±r.
        </p>
        <div style="text-align:center;font-size:10px;color:var(--muted)">‚Äî VEYA ‚Äî</div>
        <textarea id="kmlText" class="textarea"
          placeholder="<?xml version='1.0'... KML i√ßeriƒüini buraya yapƒ±≈ütƒ±rƒ±n"></textarea>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
          <select id="importTarget" class="input select" style="width:auto">
            <option value="new">Yeni ≈ûehir</option>
            <option value="append">Se√ßili ≈ûehre Ekle</option>
          </select>
          <button class="btn primary" onclick="processImportText()">ƒ∞√ße Aktar</button>
        </div>
        <p id="modalStatus" style="font-size:12px;color:var(--accent);margin:0;min-height:16px"></p>
      </div>
    </div>
  </div>

  <script>
    // --- State & Config ---
    const STORAGE_KEY = "trip_planner_v4";
    let state = { cities: [], activeCityId: null };
    let map, markersLayer, mapPoints = [];

    // --- Lifecycle ---
    window.onload = () => {
      loadState();
      initMap();
      renderAll();

      // Drag & Drop
      const dz = document.getElementById('dropzone');
      dz.ondragover = e => { e.preventDefault(); dz.style.borderColor = 'var(--accent)'; };
      dz.ondragleave = () => dz.style.borderColor = 'var(--border)';
      dz.ondrop = e => { e.preventDefault(); handleFileSelect(e.dataTransfer.files, true); };
    };

    // --- App Logic ---
    function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) state = JSON.parse(raw);
      } catch (e) { console.error(e); }
    }
    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function activeCity() { return state.cities.find(c => c.id === state.activeCityId) || null; }

    function renderAll() {
      renderCitySelect();
      renderList();
      renderRoute();
      renderMapMarkers();
      updateBadge();
    }

    function renderCitySelect() {
      const s = document.getElementById('citySelect');
      s.innerHTML = "";
      if (!state.cities.length) {
        s.innerHTML = "<option>≈ûehir Yok</option>";
        s.disabled = true;
        return;
      }
      s.disabled = false;
      state.cities.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = `${c.name} (${c.points.length})`;
        opt.selected = c.id === state.activeCityId;
        s.appendChild(opt);
      });
    }

    function changeCity() {
      const val = document.getElementById('citySelect').value;
      if (val) { state.activeCityId = val; saveState(); renderAll(); }
    }

    function renderList() {
      const c = activeCity();
      const list = document.getElementById('list');
      list.innerHTML = "";
      if (!c) return;

      const filter = document.getElementById('search').value.toLowerCase();
      const points = c.points.filter(p => !filter || p.name.toLowerCase().includes(filter));

      points.forEach(p => {
        const sel = c.selectedIds.includes(p.id);
        const div = document.createElement('div');
        div.className = "card";
        div.style.borderColor = sel ? "var(--accent)" : "";
        div.innerHTML = `
      <input type="checkbox" class="check" ${sel ? 'checked' : ''} onchange="togglePoint('${p.id}')">
      <div style="flex:1;overflow:hidden">
        <h3>${p.name}</h3>
        <div class="meta">
          <span class="tag">${p.folder || 'Genel'}</span>
        </div>
      </div>
      <button class="btn icon-btn" onclick="map.flyTo([${p.lat}, ${p.lng}], 15)">üìç</button>
    `;
        list.appendChild(div);
      });
    }

    function renderRoute() {
      const c = activeCity();
      const div = document.getElementById('itinerary');
      div.innerHTML = "";
      if (!c) return;

      const ordered = getOrderedPoints(c);
      ordered.forEach((p, idx) => {
        const row = document.createElement('div');
        row.className = 'it-item';
        row.innerHTML = `
      <div style="flex:1"><strong>${idx + 1}. ${p.name}</strong></div>
      <div class="sort-controls">
        <button class="btn icon-btn" onclick="movePoint('${p.id}', -1)" ${idx === 0 ? 'disabled' : ''}>‚Üë</button>
        <button class="btn icon-btn" onclick="movePoint('${p.id}', 1)" ${idx === ordered.length - 1 ? 'disabled' : ''}>‚Üì</button>
        <button class="btn icon-btn danger" onclick="togglePoint('${p.id}')">‚úï</button>
      </div>
    `;
        div.appendChild(row);
      });

      // Update stats display if available
      const stats = c.lastStats;
      document.getElementById('kpiKm').textContent = stats ? stats.totalKm.toFixed(1) : '-';
      document.getElementById('kpiMin').textContent = stats ? Math.round(stats.totalMin) : '-';
      document.getElementById('statsMsg').textContent = stats ? `Son hesap: ${stats.source}` : '';

      // Selection mode
      const modeSel = document.getElementById('travelMode');
      if (c.travelMode) modeSel.value = c.travelMode;
    }

    function updateBadge() {
      const c = activeCity();
      document.getElementById('cityBadge').textContent = c ? c.name : "≈ûehir Se√ßilmedi";
    }

    function initMap() {
      map = L.map('map', { zoomControl: false }).setView([41.0082, 28.9784], 11);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OSM & CartoDB'
      }).addTo(map);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    function renderMapMarkers() {
      markersLayer.clearLayers();
      const c = activeCity();
      if (!c) return;

      const bounds = [];
      c.points.forEach(p => {
        const isSel = c.selectedIds.includes(p.id);
        const color = isSel ? '#38bdf8' : '#94a3b8';

        const icon = L.divIcon({
          className: 'custom-pin',
          html: `<div style="background:${color};width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.5)"></div>`,
          iconSize: [12, 12]
        });

        const m = L.marker([p.lat, p.lng], { icon }).bindPopup(`<b>${p.name}</b><br>${p.folder || ''}`);
        m.addTo(markersLayer);
        bounds.push([p.lat, p.lng]);
      });

      if (bounds.length && !state.mapMoved) {
        map.fitBounds(bounds, { padding: [50, 50] });
        state.mapMoved = true;
      }
    }

    // --- Data Operations ---

    async function handleFileSelect(files, isNew) {
      if (!files || !files.length) return;

      let points = [];
      let name = files[0].name.replace(/\.(kml|kmz)$/i, "");

      for (let f of files) {
        try {
          let txt = "";
          if (f.name.toLowerCase().endsWith('.kmz')) {
            const buf = await readFileBuf(f);
            const zip = await JSZip.loadAsync(buf);
            const kmlFile = Object.keys(zip.files).find(n => n.endsWith('.kml'));
            if (kmlFile) txt = await zip.file(kmlFile).async("text");
          } else {
            txt = await readFileTxt(f);
          }
          if (txt) points = points.concat(parseKml(txt));
        } catch (e) { alert("Hata: " + f.name); }
      }

      if (!points.length) return alert("Nokta bulunamadƒ± (Point/LineString/Polygon parse edilemedi).");

      addCity(name, points, isNew ? 'new' : 'append');
    }

    function parseKml(xmlText) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlText, "text/xml");
      const places = [];

      const placemarks = doc.getElementsByTagName("Placemark");
      for (let p of placemarks) {
        const name = getNodeVal(p, "name") || "ƒ∞simsiz";
        const desc = getNodeVal(p, "description") || "";
        // Check MultiGeometry/Point/LineString
        let coords = "";

        // Simplistic coord finder
        const coordNodes = p.getElementsByTagName("coordinates");
        if (coordNodes.length > 0) coords = coordNodes[0].textContent.trim();

        if (coords) {
          const parts = coords.split(/\s+/)[0].split(','); // Take first point
          if (parts.length >= 2) {
            // Folder name?
            let folder = "Genel";
            if (p.parentNode && p.parentNode.nodeName === "Folder") {
              const fn = getNodeVal(p.parentNode, "name");
              if (fn) folder = fn;
            }

            places.push({ id: uid(), name, lat: parseFloat(parts[1]), lng: parseFloat(parts[0]), folder, desc });
          }
        }
      }
      return places;
    }

    function addCity(name, points, mode) {
      if (mode === 'new' || !state.cities.length) {
        // Ask for name uniqueness? default to filename
        const newCity = {
          id: uid(),
          name: name || "Yeni ≈ûehir",
          points: points,
          selectedIds: points.map(p => p.id), // Select all by default
          order: points.map(p => p.id),
          travelMode: 'walking',
          lastStats: null
        };
        state.cities.unshift(newCity);
        state.activeCityId = newCity.id;
      } else {
        // Append
        const c = activeCity();
        c.points = c.points.concat(points);
        // Add new ones to selection
        const newIds = points.map(p => p.id);
        c.selectedIds = c.selectedIds.concat(newIds);
        c.order = c.order.concat(newIds);
      }

      state.mapMoved = false; // Reset map fit trigger
      saveState();
      renderAll();
    }

    function getNodeVal(el, tag) {
      const n = el.getElementsByTagName(tag)[0];
      return n ? n.textContent.trim() : null;
    }
    function readFileTxt(f) { return new Promise(r => { const fr = new FileReader(); fr.onload = () => r(fr.result); fr.readAsText(f); }); }
    function readFileBuf(f) { return new Promise(r => { const fr = new FileReader(); fr.onload = () => r(fr.result); fr.readAsArrayBuffer(f); }); }

    // --- Point Operations ---
    function togglePoint(id) {
      const c = activeCity();
      if (!c) return;
      const idx = c.selectedIds.indexOf(id);
      if (idx > -1) {
        c.selectedIds.splice(idx, 1);
        c.order = c.order.filter(x => x !== id);
      } else {
        c.selectedIds.push(id);
        c.order.push(id);
      }
      saveState();
      renderAll();
    }

    function movePoint(id, dir) {
      const c = activeCity();
      const arr = c.order;
      const i = arr.indexOf(id);
      if (i > -1 && i + dir >= 0 && i + dir < arr.length) {
        [arr[i], arr[i + dir]] = [arr[i + dir], arr[i]];
        saveState();
        renderAll();
      }
    }

    function deleteActiveCity() {
      if (!state.activeCityId) return;
      if (confirm("Bu ≈üehri ve t√ºm noktalarƒ±nƒ± silmek istediƒüinize emin misiniz?")) {
        state.cities = state.cities.filter(c => c.id !== state.activeCityId);
        state.activeCityId = state.cities.length ? state.cities[0].id : null;
        saveState();
        renderAll();
      }
    }

    function clearRoute() {
      const c = activeCity();
      if (c) {
        c.selectedIds = [];
        c.order = [];
        c.lastStats = null;
        saveState();
        renderAll();
      }
    }

    // --- Route & Stats ---
    function getOrderedPoints(c) {
      return c.order.map(id => c.points.find(p => p.id === id)).filter(Boolean);
    }

    function updateRouteMode() {
      const c = activeCity();
      if (c) {
        c.travelMode = document.getElementById('travelMode').value;
        saveState();
      }
    }

    async function computeRoute() {
      const c = activeCity();
      if (!c) return;
      const pts = getOrderedPoints(c);
      if (pts.length < 2) return alert("En az 2 nokta gerekli.");

      const btn = document.getElementById('btnCompute');
      btn.innerText = "‚è≥";
      btn.disabled = true;

      let totalKm = 0;
      let totalMin = 0;
      let source = "Ku≈ü U√ßu≈üu (Offline)";

      // Try OSRM
      try {
        // Break into chunks if necessary, generic OSRM demo server has limits but for small routes ok
        // Using a simplistic approach: sum legs
        // mode mapping: walking, driving (car), cycling (bicycle)
        let profile = "walking";
        if (c.travelMode === 'driving') profile = "driving";
        if (c.travelMode === 'bicycling') profile = "cycling";
        if (c.travelMode === 'transit') profile = "driving"; // OSRM default no public transit

        source = "OSRM (" + profile + ")";

        for (let i = 0; i < pts.length - 1; i++) {
          const p1 = pts[i];
          const p2 = pts[i + 1];
          const url = `https://router.project-osrm.org/route/v1/${profile}/${p1.lng},${p1.lat};${p2.lng},${p2.lat}?overview=false`;

          const res = await fetch(url);
          const j = await res.json();
          if (j.routes && j.routes.length) {
            totalKm += j.routes[0].distance / 1000;
            totalMin += j.routes[0].duration / 60;
          } else {
            throw new Error("No route");
          }
          await new Promise(r => setTimeout(r, 100)); // Rate limit polite
        }
      } catch (e) {
        // Fallback Haversine
        source = "Ku≈ü U√ßu≈üu (Hata/Offline)";
        totalKm = 0; totalMin = 0;
        const speed = c.travelMode === 'walking' ? 5 : (c.travelMode === 'driving' ? 50 : 20);

        for (let i = 0; i < pts.length - 1; i++) {
          const d = haversine(pts[i], pts[i + 1]);
          totalKm += d;
          totalMin += (d / speed) * 60;
        }
      }

      c.lastStats = { totalKm, totalMin, source };
      saveState();
      renderAll(); // updates UI
      btn.innerText = "Hesapla";
      btn.disabled = false;
    }

    function haversine(p1, p2) {
      var R = 6371;
      var dLat = (p2.lat - p1.lat) * Math.PI / 180;
      var dLon = (p2.lng - p1.lng) * Math.PI / 180;
      var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function openGoogleMaps() {
      const c = activeCity();
      if (!c) return;
      const pts = getOrderedPoints(c);
      if (pts.length < 2) return alert("En az 2 nokta gerekli.");

      const origin = `${pts[0].lat},${pts[0].lng}`;
      const dest = `${pts[pts.length - 1].lat},${pts[pts.length - 1].lng}`;
      const waypoints = pts.slice(1, -1).map(p => `${p.lat},${p.lng}`).join('|');

      const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&waypoints=${waypoints}&travelmode=${c.travelMode}`;
      window.open(url, '_blank');
    }

    // --- Import Modal Logic ---
    const modal = document.getElementById('importModal');
    const urlInput = document.getElementById('urlInput');
    const kmlTextArea = document.getElementById('kmlText');
    const modalStatus = document.getElementById('modalStatus');

    function openImportModal() {
      modal.classList.add('open');
      urlInput.value = "";
      kmlTextArea.value = "";
      modalStatus.textContent = "";
    }
    function closeImportModal() { modal.classList.remove('open'); }

    async function fetchFromUrl() {
      const rawUrl = urlInput.value.trim();
      if (!rawUrl) return;

      const btn = document.getElementById('btnFetch');
      btn.disabled = true;
      btn.textContent = "...";
      modalStatus.textContent = "Baƒülanƒ±yor...";

      // Smart MyMaps URL logic
      let fetchUrl = rawUrl;

      // Detect standard viewer URL: google.com/maps/d/viewer?mid=XXXXX
      // We need to convert it to: google.com/maps/d/kml?mid=XXXXX
      if (rawUrl.includes("maps/d/") && (rawUrl.includes("viewer") || rawUrl.includes("edit"))) {
        try {
          const u = new URL(rawUrl);
          const mid = u.searchParams.get("mid");
          if (mid) {
            // Direct KML export link
            // Note: Direct fetch from browser to google.com often fails CORS.
            // We will try a CORS proxy if direct fails, or warn user.
            fetchUrl = `https://www.google.com/maps/d/kml?mid=${mid}&forcekml=1`;
          }
        } catch (e) { }
      }

      try {
        // Attempt 1: Direct
        let res = await fetch(fetchUrl).catch(() => null);

        // Attempt 2: CORS Proxy (using a public one for demo: corsproxy.io)
        if (!res || !res.ok) {
          modalStatus.textContent = "Direkt eri≈üim engellendi, proxy deneniyor...";
          const proxy = "https://corsproxy.io/?";
          res = await fetch(proxy + encodeURIComponent(fetchUrl));
        }

        if (res.ok) {
          const text = await res.text();
          kmlTextArea.value = text;
          modalStatus.textContent = "KML ba≈üarƒ±yla alƒ±ndƒ±! 'ƒ∞√ße Aktar' tu≈üuna basƒ±n.";
        } else {
          throw new Error("Eri≈üim hatasƒ±");
        }
      } catch (e) {
        console.error(e);
        modalStatus.innerHTML = `Hata: URL okunamadƒ± (CORS). <br>L√ºtfen linki tarayƒ±cƒ±da a√ßƒ±p inen dosyayƒ± y√ºkleyin veya i√ßeriƒüi yapƒ±≈ütƒ±rƒ±n.`;
      }

      btn.disabled = false;
      btn.textContent = "Getir";
    }

    function processImportText() {
      const txt = kmlTextArea.value.trim();
      if (!txt) return alert("ƒ∞√ßerik bo≈ü.");
      if (!txt.startsWith("<?xml") && !txt.includes("<kml")) return alert("Ge√ßersiz KML formatƒ±.");

      try {
        const points = parseKml(txt);
        if (!points.length) throw new Error("Nokta bulunamadƒ±");

        // Determine target
        const target = document.getElementById('importTarget').value; // 'new' or 'append'
        let mainName = "ƒ∞√ße Aktarƒ±lan";
        const nameInput = document.getElementById('kmlCityName');
        if (nameInput && nameInput.value.trim()) mainName = nameInput.value.trim();

        // Group by folder
        const groups = {};
        points.forEach(p => {
          const k = p.folder || "Genel";
          if (!groups[k]) groups[k] = [];
          groups[k].push(p);
        });
        const folderNames = Object.keys(groups);

        // Logic: If 'new' mode AND multiple folders exist -> Split them
        if (target === 'new' && folderNames.length > 1) {
          // Iterate in reverse so the first folder ends up at the top of the list (since addCity uses unshift)
          for (let i = folderNames.length - 1; i >= 0; i--) {
            const fname = folderNames[i];
            // Use folder name as city name
            addCity(fname, groups[fname], 'new');
          }
          alert(`ƒ∞≈ülem tamam! ${folderNames.length} ayrƒ± katman (≈üehir) olarak eklendi.`);
        } else {
          // Standard merge (single folder or append mode)
          if (folderNames.length === 1 && target === 'new' && !nameInput.value.trim()) {
            mainName = folderNames[0]; // Auto-name from folder if single
          }
          addCity(mainName, points, target);
          alert(`${points.length} nokta ba≈üarƒ±yla eklendi.`);
        }

        closeImportModal();
        search.value = "";
        renderAll();

      } catch (e) {
        alert("Hata: " + e.message);
      }
    }

    // Mobile Tab Switcher
    function showTab(id) {
      document.querySelectorAll('.mobile-nav .btn').forEach(b => b.classList.remove('primary'));
      // simplistic toggle, real app would use state
      const cols = ['colList', 'colMap', 'colRoute'];
      const isMobile = window.innerWidth <= 768;

      if (isMobile) {
        cols.forEach(c => document.getElementById(c).style.display = 'none');
        document.getElementById(id).style.display = 'flex';
      }
    }
  </script>
</body>

</html>