<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gezi Planlayƒ±cƒ± (Mobil / Offline Lite)</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#0b1220; --muted:#9fb0d0; --text:#eef2ff;
      --border:rgba(255,255,255,.12); --accent:#6aa5ff; --accent2:#7cf1d6; --danger:#ff6a7a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 15% 10%, rgba(106,165,255,.18), transparent 60%),
                  radial-gradient(900px 700px at 80% 30%, rgba(124,241,214,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .container{ max-width:1100px; margin:0 auto; padding:12px; }
    .topbar{
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow);
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }
    h1{ font-size:16px; margin:0 0 4px 0; letter-spacing:.2px; }
    .sub{ margin:0; color:var(--muted); font-size:12px; line-height:1.4; max-width: 760px; }
    .badge{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      font-size:12px; color:var(--muted);
      border:1px solid var(--border); background:rgba(0,0,0,.16); padding:8px 10px; border-radius:12px;
    }

    .mobileSwitcher{
      margin-top:10px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.16);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex;
    }
    .segBtn{
      flex:1 1 0;
      border:0;
      padding:12px 10px;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      font-size:12.5px;
    }
    .segBtn.active{
      background: rgba(124,241,214,.12);
      color: var(--text);
      font-weight: 800;
    }

    .panel{
      margin-top:10px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    .panelHeader{
      padding:12px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
    }
    .panelHeader h2{ margin:0; font-size:13.5px; letter-spacing:.2px; }
    .controls{
      padding:10px 12px 12px 12px;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      border-bottom:1px solid var(--border);
    }
    .input, select, textarea{
      padding:9px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .input{ flex:1 1 220px; min-width:200px; }
    select{ flex:0 0 240px; min-width:210px; }
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:9px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn.primary{ border-color: rgba(124,241,214,.45); background: rgba(124,241,214,.12); }
    .btn.danger{ border-color: rgba(255,106,122,.45); background: rgba(255,106,122,.12); }
    .btn[aria-disabled="true"]{ opacity:.45; cursor:not-allowed; pointer-events:none; }

    /* File input: keep in DOM for iOS */
    .fileInput{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;
      clip: rect(0,0,0,0);
      white-space:nowrap;
      border:0;
      opacity:0;
    }

    .list{ padding:10px; display:grid; gap:8px; }
    .card{
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .cardLeft{ display:flex; gap:10px; }
    .check{ margin-top:2px; width:18px; height:18px; accent-color: var(--accent); }
    .card h3{ margin:0; font-size:13px; }
    .meta{ margin-top:6px; color:var(--muted); font-size:11.5px; display:flex; gap:8px; flex-wrap:wrap; }
    .tag{
      display:inline-block;
      font-size:10.5px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      margin-top:7px;
    }
    .small{ font-size:10.8px; color:var(--muted); margin-top:6px; line-height:1.35; }

    .itinerary{ padding:10px; display:grid; gap:8px; }
    .itItem{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      padding:9px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .itItem strong{ font-size:12.8px; }
    .itControls{ display:flex; gap:6px; }
    .iconBtn{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      cursor:pointer;
    }

    .statsBox{
      margin:10px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.14);
      border-radius:14px;
      padding:10px;
    }
    .statsTop{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
      color:var(--muted); font-size:11.8px;
    }
    .kpi strong{ color:var(--text); }
    .legs{ display:grid; gap:8px; margin-top:10px; }
    .leg{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:12px;
      padding:9px;
      font-size:12px;
      color:var(--muted);
    }
    .leg .t{ color:var(--text); font-weight:800; margin-bottom:4px; }

    .noteBox{
      padding:10px 12px 12px 12px;
      border-top:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    /* Modal */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 9999;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: min(920px, 100%);
      max-height: 90vh;
      overflow: auto;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.22));
      box-shadow: var(--shadow);
    }
    .modalHeader{
      padding: 12px 12px 10px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .modalTitle{ font-size: 13.5px; font-weight: 900; letter-spacing:.2px; }
    .modalSub{ margin-top: 4px; font-size: 12px; color: var(--muted); line-height:1.4; }
    .modalBody{ padding: 10px 12px 12px 12px; display:grid; gap: 10px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .textArea{
      width: 100%;
      min-height: 180px;
      resize: vertical;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.45;
    }

    /* Views */
    body.show-left #rightPanel{ display:none; }
    body.show-right #leftPanel{ display:none; }
  </style>
</head>
<body class="show-left">
  <div class="container">
    <div class="topbar">
      <div>
        <h1>Gezi Planlayƒ±cƒ± (Mobil / Offline Lite)</h1>
        <p class="sub">
          Bu s√ºr√ºm <strong>harita k√ºt√ºphanesi kullanmaz</strong> (daha stabil). KML dosyalarƒ±nƒ± √ßoklu ekleyin, her dosya ayrƒ± ≈üehir olur.
          ‚ÄúKm/Dk‚Äù i√ßin internet varsa OSRM, yoksa offline yakla≈üƒ±k hesap kullanƒ±r. Ba≈ülangƒ±√ß: <strong>en kuzeydeki</strong> se√ßili nokta.
        </p>
      </div>
      <div class="badge">
        <span>≈ûehir: <strong id="badgeCity" style="color:var(--text)">-</strong></span>
        <span style="opacity:.6">|</span>
        <span>Se√ßili: <strong id="badgeSel" style="color:var(--text)">0</strong></span>
      </div>
    </div>

    <div class="mobileSwitcher" aria-label="Mobil g√∂r√ºn√ºm se√ßici">
      <button class="segBtn active" id="segLeft" type="button">Liste</button>
      <button class="segBtn" id="segRight" type="button">Rota</button>
    </div>

    <!-- LEFT -->
    <div class="panel" id="leftPanel">
      <div class="panelHeader">
        <h2>≈ûehirler, ƒ∞√ße Aktarƒ±m ve Liste</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;">
          <button class="btn primary" id="btnPasteKml" type="button">KML yapƒ±≈ütƒ±r / URL</button>
          <button class="btn danger" id="btnResetAll" type="button">T√ºm√ºn√º sƒ±fƒ±rla</button>
        </div>
      </div>

      <div class="controls">
        <select id="citySelect"></select>

        <input id="fileNew" class="fileInput" type="file" accept="*/*" multiple />
        <label class="btn primary" id="btnNewCity" for="fileNew">Yeni ≈üehir (√ßoklu KML)</label>

        <input id="fileAppend" class="fileInput" type="file" accept="*/*" multiple />
        <label class="btn" id="btnAppendCity" for="fileAppend" aria-disabled="true">Aktif ≈üehre ekle</label>

        <button class="btn" id="btnRenameCity" type="button">Yeniden adlandƒ±r</button>
        <button class="btn danger" id="btnDeleteCity" type="button">≈ûehri sil</button>

        <input class="input" id="search" placeholder="Ara: isim veya a√ßƒ±klama..." />
      </div>

      <div class="list" id="list"></div>

      <div class="noteBox">
        Not: Bu ‚Äúlite‚Äù s√ºr√ºm sadece <strong>.kml</strong> destekler (KMZ yok). En stabil kullanƒ±m i√ßin yeterlidir.
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel" id="rightPanel">
      <div class="panelHeader">
        <h2>Rotam</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
          <span style="color:var(--muted); font-size:12px;">Ula≈üƒ±m:</span>
          <select id="travelMode" style="min-width:200px">
            <option value="walking">Y√ºr√ºy√º≈ü</option>
            <option value="driving">Araba</option>
            <option value="transit">Toplu ta≈üƒ±ma</option>
            <option value="bicycling">Bisiklet</option>
          </select>
        </div>
      </div>

      <div class="itinerary" id="itinerary"></div>

      <div class="statsBox">
        <div class="statsTop">
          <div class="kpi">
            <span>Toplam: <strong id="kpiKm">-</strong> km</span>
            <span>S√ºre: <strong id="kpiMin">-</strong> dk</span>
            <span>Kaynak: <strong id="kpiSrc">-</strong></span>
            <span>Ba≈ülangƒ±√ß: <strong id="kpiStart">-</strong></span>
          </div>
          <button class="btn primary" id="btnCompute" type="button">Km/Dk Hesapla</button>
        </div>
        <div style="color:var(--muted); font-size:12px;" id="statsMsg">Km/Dk hesabƒ± i√ßin en az 2 nokta se√ßin.</div>
        <div class="legs" id="legs"></div>
      </div>

      <div class="controls" style="border-top:1px solid var(--border)">
        <button class="btn danger" id="btnClearRoute" type="button">Rotayƒ± temizle</button>
        <button class="btn" id="btnExportJson" type="button">JSON dƒ±≈üa aktar</button>
        <button class="btn primary" id="btnOpenMaps" type="button">Google Maps‚Äôte a√ß</button>
      </div>

      <div class="noteBox">
        ƒ∞pucu: ‚ÄúGoogle Maps‚Äôte a√ß‚Äù, se√ßili noktalarla rota linki √ºretir. Km/Dk hesabƒ±nda ba≈ülangƒ±√ß en kuzey nokta alƒ±nƒ±r.
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHeader">
        <div>
          <div class="modalTitle" id="modalTitle">KML ƒ∞√ße Aktar (Dosya kaydetmeden)</div>
          <div class="modalSub">KML i√ßeriƒüini yapƒ±≈ütƒ±rƒ±n veya KML baƒülantƒ±sƒ± girin. Bazƒ± URL‚Äôler CORS nedeniyle engellenebilir.</div>
        </div>
        <button class="iconBtn" id="btnModalClose" type="button" title="Kapat">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="row">
          <input class="input" id="kmlUrl" placeholder="KML URL (opsiyonel, .kml)" />
          <button class="btn" id="btnFetchUrl" type="button">URL‚Äôden getir</button>
        </div>
        <textarea id="kmlText" class="textArea" placeholder="KML i√ßeriƒüini buraya yapƒ±≈ütƒ±rƒ±n (<?xml ...> ile ba≈ülayan)"></textarea>
        <div class="row">
          <input class="input" id="kmlCityName" placeholder="≈ûehir adƒ± (bo≈üsa otomatik)" />
          <select id="kmlTarget" class="input" style="flex:0 0 220px; min-width:200px">
            <option value="new">Yeni ≈üehir olarak ekle</option>
            <option value="append">Aktif ≈üehre ekle</option>
          </select>
        </div>
        <div class="row" style="justify-content:space-between; align-items:center">
          <div style="color:var(--muted); font-size:12px;" id="modalStatus">Hazƒ±r.</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
            <button class="btn" id="btnPasteSample" type="button">√ñrnek KML</button>
            <button class="btn primary" id="btnImportText" type="button">ƒ∞√ße aktar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  var STORAGE_KEY = "tripPlanner.offlineLite.v1";

  // UI
  var citySelect = document.getElementById("citySelect");
  var fileNew = document.getElementById("fileNew");
  var fileAppend = document.getElementById("fileAppend");
  var btnAppendCity = document.getElementById("btnAppendCity");
  var btnRenameCity = document.getElementById("btnRenameCity");
  var btnDeleteCity = document.getElementById("btnDeleteCity");
  var btnResetAll = document.getElementById("btnResetAll");
  var search = document.getElementById("search");
  var listEl = document.getElementById("list");
  var itineraryEl = document.getElementById("itinerary");
  var travelModeEl = document.getElementById("travelMode");
  var btnClearRoute = document.getElementById("btnClearRoute");
  var btnExportJson = document.getElementById("btnExportJson");
  var btnOpenMaps = document.getElementById("btnOpenMaps");
  var badgeCity = document.getElementById("badgeCity");
  var badgeSel = document.getElementById("badgeSel");

  var segLeft = document.getElementById("segLeft");
  var segRight = document.getElementById("segRight");

  // Modal
  var btnPasteKml = document.getElementById("btnPasteKml");
  var modalOverlay = document.getElementById("modalOverlay");
  var btnModalClose = document.getElementById("btnModalClose");
  var btnFetchUrl = document.getElementById("btnFetchUrl");
  var btnImportText = document.getElementById("btnImportText");
  var btnPasteSample = document.getElementById("btnPasteSample");
  var kmlUrlEl = document.getElementById("kmlUrl");
  var kmlTextEl = document.getElementById("kmlText");
  var kmlCityNameEl = document.getElementById("kmlCityName");
  var kmlTargetEl = document.getElementById("kmlTarget");
  var modalStatus = document.getElementById("modalStatus");

  // Stats UI
  var btnCompute = document.getElementById("btnCompute");
  var kpiKm = document.getElementById("kpiKm");
  var kpiMin = document.getElementById("kpiMin");
  var kpiSrc = document.getElementById("kpiSrc");
  var kpiStart = document.getElementById("kpiStart");
  var statsMsg = document.getElementById("statsMsg");
  var legsEl = document.getElementById("legs");

  var state = { cities: [], activeCityId: null };

  function nowIso(){ return new Date().toISOString(); }
  function uid(){
    try{ if(window.crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return String(Math.random()).slice(2) + String(Date.now());
  }
  function baseName(fileName){
    var n = (fileName || "").split(/[\\/]/).pop() || "";
    return n.replace(/\.(kml)$/i, "") || "Yeni ≈ûehir";
  }
  function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }
  function load(){
    try{
      var raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      var parsed = JSON.parse(raw);
      if(parsed && parsed.cities && parsed.cities.length >= 0) state.cities = parsed.cities;
      if(typeof parsed.activeCityId === "string") state.activeCityId = parsed.activeCityId;
    }catch(e){}
  }
  function activeCity(){
    for(var i=0;i<state.cities.length;i++){
      if(state.cities[i].id === state.activeCityId) return state.cities[i];
    }
    return null;
  }
  function updateActiveCity(patchFn){
    for(var i=0;i<state.cities.length;i++){
      if(state.cities[i].id === state.activeCityId){
        state.cities[i] = patchFn(state.cities[i]);
        break;
      }
    }
    save();
  }

  function escapeHtml(s){
    return String(s || "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
  function stripHtml(s){ return String(s||"").replace(/<[^>]+>/g,""); }

  // KML parse (Point/LineString/Polygon first coordinate)
  function safeText(node){ return (node && node.textContent ? node.textContent : "").trim(); }
  function firstCoordinateText(coordText){
    var t = String(coordText || "").trim();
    if(!t) return null;
    var first = t.split(/\s+/)[0];
    var parts = first.split(",");
    if(parts.length < 2) return null;
    var lng = Number(parts[0]);
    var lat = Number(parts[1]);
    if(!isFinite(lat) || !isFinite(lng)) return null;
    return { lat: lat, lng: lng };
  }
  function folderPathForPlacemark(pm){
    var names = [];
    var cur = pm.parentNode;
    while(cur){
      var local = (cur.localName || "").toLowerCase();
      if(local === "folder"){
        var kids = cur.childNodes || [];
        var nameEl = null;
        for(var i=0;i<kids.length;i++){
          var ln = (kids[i].localName || "").toLowerCase();
          if(ln === "name"){ nameEl = kids[i]; break; }
        }
        var nm = safeText(nameEl);
        if(nm) names.push(nm);
      }
      cur = cur.parentNode;
    }
    names.reverse();
    return names.join(" / ");
  }
  function parseKmlText(kmlText){
    var xml = new DOMParser().parseFromString(kmlText, "application/xml");
    if(xml.querySelector("parsererror")){ throw new Error("KML parse edilemedi (XML hatasƒ±)."); }
    var placemarks = xml.getElementsByTagName("Placemark");
    var points = [];
    for(var i=0;i<placemarks.length;i++){
      var pm = placemarks[i];
      var nameEl = pm.getElementsByTagName("name")[0];
      var descEl = pm.getElementsByTagName("description")[0];
      var name = safeText(nameEl) || "ƒ∞simsiz nokta";
      var description = safeText(descEl) || "";

      var geomType = "Unknown";
      var coord = null;

      var pointEl = pm.getElementsByTagName("Point")[0];
      var lineEl = pm.getElementsByTagName("LineString")[0];
      var polyEl = pm.getElementsByTagName("Polygon")[0];

      if(pointEl){
        geomType = "Point";
        coord = firstCoordinateText(safeText(pointEl.getElementsByTagName("coordinates")[0]));
      }else if(lineEl){
        geomType = "LineString";
        coord = firstCoordinateText(safeText(lineEl.getElementsByTagName("coordinates")[0]));
      }else if(polyEl){
        geomType = "Polygon";
        coord = firstCoordinateText(safeText(polyEl.getElementsByTagName("coordinates")[0]));
      }
      if(!coord) continue;

      points.push({
        id: uid(),
        name: name,
        description: description,
        lat: coord.lat,
        lng: coord.lng,
        geomType: geomType,
        folderPath: folderPathForPlacemark(pm)
      });
    }
    return points;
  }

  function readFileAsText(file){
    return new Promise(function(resolve,reject){
      var r = new FileReader();
      r.onload = function(){ resolve(String(r.result || "")); };
      r.onerror = function(){ reject(new Error("Dosya okunamadƒ±.")); };
      r.readAsText(file);
    });
  }
  function fileToPoints(file){
    return readFileAsText(file).then(function(kmlText){
      return parseKmlText(kmlText);
    });
  }

  function importNewCityFromPoints(points, name){
    if(!points || !points.length) throw new Error("KML i√ßinde koordinatlƒ± √∂ƒüe bulunamadƒ±.");
    var city = {
      id: uid(),
      name: name || "Yeni ≈ûehir",
      createdAt: nowIso(),
      updatedAt: nowIso(),
      points: points,
      selectedIds: points.map(function(p){ return p.id; }),
      order: points.map(function(p){ return p.id; }),
      travelMode: "walking",
      lastStats: null
    };
    state.cities.unshift(city);
    state.activeCityId = city.id;
    save();
    return city;
  }

  function appendPointsToActive(points){
    var c = activeCity();
    if(!c) throw new Error("Aktif ≈üehir yok.");
    updateActiveCity(function(city){
      var pointsAll = (city.points || []).concat(points);
      var selectedIds = (city.selectedIds || []).concat(points.map(function(p){ return p.id; }));
      var order = (city.order || []).concat(points.map(function(p){ return p.id; }));
      city.points = pointsAll;
      city.selectedIds = selectedIds;
      city.order = order;
      city.updatedAt = nowIso();
      city.lastStats = null;
      return city;
    });
  }

  function handleMultiNew(files){
    var arr = [];
    for(var i=0;i<files.length;i++) arr.push(files[i]);
    if(!arr.length) return;
    var askName = (arr.length === 1);
    var p = Promise.resolve();
    for(var k=0;k<arr.length;k++){
      (function(f){
        p = p.then(function(){
          return fileToPoints(f).then(function(points){
            var name = baseName(f.name);
            if(askName){
              var n2 = prompt("≈ûehir adƒ± (kayƒ±t ismi):", name);
              if(n2) name = n2;
            }
            importNewCityFromPoints(points, name);
          });
        });
      })(arr[k]);
    }
    return p.then(function(){
      search.value = "";
      renderAll();
    }).catch(function(e){
      alert(e && e.message ? e.message : String(e));
      renderAll();
    });
  }

  function handleMultiAppend(files){
    var c = activeCity();
    if(!c){ alert("√ñnce bir ≈üehir olu≈üturun."); return; }
    var arr = [];
    for(var i=0;i<files.length;i++) arr.push(files[i]);
    if(!arr.length) return;
    var p = Promise.resolve();
    for(var k=0;k<arr.length;k++){
      (function(f){
        p = p.then(function(){
          return fileToPoints(f).then(function(points){
            if(!points.length) throw new Error("KML bo≈ü g√∂r√ºn√ºyor: " + f.name);
            appendPointsToActive(points);
          });
        });
      })(arr[k]);
    }
    return p.then(function(){
      search.value = "";
      renderAll();
    }).catch(function(e){
      alert(e && e.message ? e.message : String(e));
      renderAll();
    });
  }

  function renameActiveCity(){
    var c = activeCity();
    if(!c) return;
    var name = prompt("≈ûehir adƒ±nƒ± g√ºncelle:", c.name);
    if(!name) return;
    updateActiveCity(function(city){
      city.name = name;
      city.updatedAt = nowIso();
      return city;
    });
    renderAll();
  }

  function deleteActiveCity(){
    var c = activeCity();
    if(!c) return;
    if(!confirm("\"" + c.name + "\" kaydƒ±nƒ± silmek istiyor musunuz?")) return;
    var next = [];
    for(var i=0;i<state.cities.length;i++){
      if(state.cities[i].id !== c.id) next.push(state.cities[i]);
    }
    state.cities = next;
    state.activeCityId = state.cities.length ? state.cities[0].id : null;
    save();
    renderAll();
  }

  function resetAll(){
    if(!confirm("T√ºm ≈üehir kayƒ±tlarƒ±nƒ± silmek istiyor musunuz?")) return;
    state = { cities: [], activeCityId: null };
    try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
    renderAll();
  }

  function toggleSelect(pointId){
    var c = activeCity(); if(!c) return;
    updateActiveCity(function(city){
      var sel = {};
      var i;
      for(i=0;i<(city.selectedIds||[]).length;i++) sel[city.selectedIds[i]] = true;
      if(sel[pointId]) delete sel[pointId]; else sel[pointId] = true;
      var selectedIds = [];
      for(i in sel) if(sel.hasOwnProperty(i)) selectedIds.push(i);

      // keep order only for selected
      var prevOrder = city.order || [];
      var nextOrder = [];
      for(i=0;i<prevOrder.length;i++) if(sel[prevOrder[i]]) nextOrder.push(prevOrder[i]);
      for(i=0;i<selectedIds.length;i++) if(nextOrder.indexOf(selectedIds[i]) < 0) nextOrder.push(selectedIds[i]);

      city.selectedIds = selectedIds;
      city.order = nextOrder;
      city.updatedAt = nowIso();
      city.lastStats = null;
      return city;
    });
    renderAll();
  }

  function move(pointId, dir){
    var c = activeCity(); if(!c) return;
    updateActiveCity(function(city){
      var ord = (city.order || []).slice();
      var i = ord.indexOf(pointId);
      var j = i + dir;
      if(i < 0 || j < 0 || j >= ord.length) return city;
      var tmp = ord[i]; ord[i] = ord[j]; ord[j] = tmp;
      city.order = ord;
      city.updatedAt = nowIso();
      city.lastStats = null;
      return city;
    });
    renderAll();
  }

  function clearRoute(){
    var c = activeCity(); if(!c) return;
    updateActiveCity(function(city){
      city.selectedIds = [];
      city.order = [];
      city.updatedAt = nowIso();
      city.lastStats = null;
      return city;
    });
    renderAll();
  }

  function selectedOrderedPoints(city){
    var pts = city.points || [];
    var sel = {};
    for(var i=0;i<(city.selectedIds||[]).length;i++) sel[city.selectedIds[i]] = true;
    var map = {};
    for(i=0;i<pts.length;i++) map[pts[i].id] = pts[i];
    var ordered = [];
    var ord = city.order || [];
    for(i=0;i<ord.length;i++){
      var p = map[ord[i]];
      if(p && sel[p.id]) ordered.push(p);
    }
    return ordered;
  }

  function startFromNorthmost(points){
    if(!points || points.length < 2) return points || [];
    var idx = 0;
    for(var i=1;i<points.length;i++){
      if(points[i].lat > points[idx].lat) idx = i;
    }
    var start = points[idx];
    var rest = [];
    for(i=0;i<points.length;i++) if(i !== idx) rest.push(points[i]);
    return [start].concat(rest);
  }

  function buildGoogleMapsUrl(orderedPoints, travelMode){
    if(!orderedPoints || !orderedPoints.length) return null;
    var origin = orderedPoints[0].lat + "," + orderedPoints[0].lng;
    var dest = orderedPoints[orderedPoints.length-1].lat + "," + orderedPoints[orderedPoints.length-1].lng;
    var wps = [];
    for(var i=1;i<orderedPoints.length-1;i++){
      wps.push(orderedPoints[i].lat + "," + orderedPoints[i].lng);
    }
    var params = [];
    params.push("api=1");
    params.push("origin=" + encodeURIComponent(origin));
    params.push("destination=" + encodeURIComponent(dest));
    if(wps.length) params.push("waypoints=" + encodeURIComponent(wps.join("|")));
    params.push("travelmode=" + encodeURIComponent(travelMode || "walking"));
    return "https://www.google.com/maps/dir/?" + params.join("&");
  }

  function openMaps(){
    var c = activeCity(); if(!c) return;
    var ordered = startFromNorthmost(selectedOrderedPoints(c));
    if(ordered.length < 2){ alert("Google Maps rotasƒ± i√ßin en az 2 nokta se√ßin."); return; }
    var url = buildGoogleMapsUrl(ordered, c.travelMode);
    window.open(url, "_blank");
  }

  function exportJson(){
    var c = activeCity(); if(!c) return;
    var ordered = selectedOrderedPoints(c);
    var out = [];
    for(var i=0;i<ordered.length;i++){
      var p = ordered[i];
      out.push({
        id: p.id,
        name: p.name,
        category: p.folderPath ? [p.folderPath] : [c.name],
        duration: "",
        lat: p.lat,
        lng: p.lng,
        note: stripHtml(p.description).slice(0,600)
      });
    }
    var blob = new Blob([JSON.stringify(out, null, 2)], {type:"application/json"});
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = c.name + "-places.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    try{ URL.revokeObjectURL(a.href); }catch(e){}
  }

  // KM/DK
  function mapModeToOsrmProfile(mode){
    if(mode === "walking") return "walking";
    if(mode === "bicycling") return "cycling";
    if(mode === "driving") return "driving";
    if(mode === "transit") return "driving";
    return "walking";
  }
  function modeSpeedKmh(mode){
    if(mode === "walking") return 5;
    if(mode === "bicycling") return 15;
    if(mode === "driving") return 40;
    if(mode === "transit") return 25;
    return 5;
  }
  function haversineKm(lat1, lon1, lat2, lon2){
    var R = 6371;
    var toRad = function(x){ return x * Math.PI / 180; };
    var dLat = toRad(lat2 - lat1);
    var dLon = toRad(lon2 - lon1);
    var a = Math.sin(dLat/2)*Math.sin(dLat/2) +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }
  function osrmLeg(a, b, profile){
    var url = "https://router.project-osrm.org/route/v1/" + profile + "/" + a.lng + "," + a.lat + ";" + b.lng + "," + b.lat + "?overview=false";
    return fetch(url, { cache: "no-store" }).then(function(r){
      if(!r.ok) throw new Error("OSRM yanƒ±t hatasƒ±");
      return r.json();
    }).then(function(j){
      if(!j.routes || !j.routes.length) throw new Error("OSRM rota bulamadƒ±");
      return { distance_m: j.routes[0].distance, duration_s: j.routes[0].duration };
    });
  }

  function computeRouteStats(){
    var c = activeCity(); if(!c) return;
    var ptsRaw = selectedOrderedPoints(c);
    var pts = startFromNorthmost(ptsRaw);
    if(pts.length < 2){
      statsMsg.textContent = "Km/Dk hesabƒ± i√ßin en az 2 nokta se√ßin.";
      return;
    }
    btnCompute.disabled = true;
    statsMsg.textContent = "Hesaplanƒ±yor...";
    legsEl.innerHTML = "";

    var startName = pts[0].name || "-";
    var mode = c.travelMode || "walking";
    var profile = mapModeToOsrmProfile(mode);

    var totalKm = 0;
    var totalMin = 0;
    var legs = [];
    var source = "OSRM";

    // Try OSRM, fallback offline
    var chain = Promise.resolve();
    for(var i=0;i<pts.length-1;i++){
      (function(a,b){
        chain = chain.then(function(){
          return osrmLeg(a,b,profile).then(function(leg){
            var km = leg.distance_m / 1000;
            var min = leg.duration_s / 60;
            legs.push({ from: a.name, to: b.name, km: km, min: min, src: "OSRM" });
            totalKm += km;
            totalMin += min;
          });
        });
      })(pts[i], pts[i+1]);
    }

    chain.then(function(){
      if(mode === "transit") source = "OSRM (driving approx)";
      statsMsg.textContent = "Hesaplandƒ±. Ba≈ülangƒ±√ß en kuzey nokta olarak alƒ±ndƒ±.";
      updateActiveCity(function(city){
        city.lastStats = { computedAt: nowIso(), mode: mode, source: source, startName: startName, totalKm: totalKm, totalMin: totalMin, legs: legs };
        return city;
      });
      btnCompute.disabled = false;
      renderStats();
    }).catch(function(){
      source = "Offline approx";
      var spd = modeSpeedKmh(mode);
      legs = [];
      totalKm = 0;
      totalMin = 0;
      for(var j=0;j<pts.length-1;j++){
        var a = pts[j], b = pts[j+1];
        var km2 = haversineKm(a.lat, a.lng, b.lat, b.lng);
        var min2 = (km2 / spd) * 60;
        legs.push({ from: a.name, to: b.name, km: km2, min: min2, src: "Haversine+speed" });
        totalKm += km2;
        totalMin += min2;
      }
      statsMsg.textContent = "OSRM eri≈üilemedi. Offline yakla≈üƒ±k hesap kullanƒ±ldƒ±. Ba≈ülangƒ±√ß en kuzey nokta.";
      updateActiveCity(function(city){
        city.lastStats = { computedAt: nowIso(), mode: mode, source: source, startName: startName, totalKm: totalKm, totalMin: totalMin, legs: legs };
        return city;
      });
      btnCompute.disabled = false;
      renderStats();
    });
  }

  // Modal
  function setModalStatus(msg){ if(modalStatus) modalStatus.textContent = msg; }
  function showModal(){
    modalOverlay.classList.add("show");
    modalOverlay.setAttribute("aria-hidden","false");
    setModalStatus("Hazƒ±r.");
    // default target
    if(activeCity()) kmlTargetEl.value = "new"; else kmlTargetEl.value = "new";
  }
  function hideModal(){
    modalOverlay.classList.remove("show");
    modalOverlay.setAttribute("aria-hidden","true");
  }
  function fetchTextFromUrl(url){
    return fetch(url, { cache: "no-store" }).then(function(r){
      if(!r.ok) throw new Error("URL okunamadƒ± (HTTP " + r.status + ")");
      return r.text();
    });
  }
  function importFromKmlText(kmlText, cityName, target){
    var text = String(kmlText || "").trim();
    if(!text) throw new Error("KML i√ßeriƒüi bo≈ü.");
    var points = parseKmlText(text);
    if(!points.length) throw new Error("KML i√ßinde koordinatlƒ± √∂ƒüe bulunamadƒ±.");

    if(target === "append" && !activeCity()) target = "new";

    if(target === "append"){
      appendPointsToActive(points);
      return { mode: "append", count: points.length };
    }else{
      var nm = (cityName && cityName.trim()) ? cityName.trim() : "Yeni ≈ûehir";
      importNewCityFromPoints(points, nm);
      return { mode: "new", count: points.length, name: nm };
    }
  }

  // Render
  function renderCitySelect(){
    citySelect.innerHTML = "";
    if(!state.cities.length){
      var opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Hen√ºz ≈üehir yok";
      citySelect.appendChild(opt);
      citySelect.disabled = true;
      return;
    }
    citySelect.disabled = false;
    for(var i=0;i<state.cities.length;i++){
      var c = state.cities[i];
      var o = document.createElement("option");
      o.value = c.id;
      o.textContent = c.name + " (" + (c.points ? c.points.length : 0) + ")";
      citySelect.appendChild(o);
    }
    citySelect.value = state.activeCityId || state.cities[0].id;
  }

  function renderBadge(){
    var c = activeCity();
    badgeCity.textContent = c ? c.name : "-";
    badgeSel.textContent = c ? (c.selectedIds ? c.selectedIds.length : 0) : "0";
  }

  function renderList(){
    listEl.innerHTML = "";
    var c = activeCity();
    if(!c){
      listEl.innerHTML = '<div style="color:var(--muted); font-size:12px; padding:10px">Hen√ºz ≈üehir yok. ‚ÄúYeni ≈üehir‚Äù ile ba≈ülayƒ±n.</div>';
      return;
    }
    var q = (search.value || "").trim().toLowerCase();
    var pts = c.points || [];
    var selected = {};
    for(var i=0;i<(c.selectedIds||[]).length;i++) selected[c.selectedIds[i]] = true;

    var filtered = [];
    for(i=0;i<pts.length;i++){
      var p = pts[i];
      var ok = true;
      if(q){
        var n = (p.name||"").toLowerCase();
        var d = (p.description||"").toLowerCase();
        ok = (n.indexOf(q) >= 0) || (d.indexOf(q) >= 0);
      }
      if(ok) filtered.push(p);
    }

    for(i=0;i<filtered.length;i++){
      (function(p){
        var card = document.createElement("div");
        card.className = "card";

        var left = document.createElement("div");
        left.className = "cardLeft";

        var cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "check";
        cb.checked = !!selected[p.id];
        cb.addEventListener("change", function(){ toggleSelect(p.id); });

        var body = document.createElement("div");
        body.innerHTML =
          "<h3>" + escapeHtml(p.name) + "</h3>" +
          '<div class="meta">' +
            "<span>üìç " + p.lat.toFixed(5) + ", " + p.lng.toFixed(5) + "</span>" +
            "<span>üß≠ " + escapeHtml(p.geomType || "Unknown") + "</span>" +
          "</div>" +
          '<div class="tag">' + escapeHtml(p.folderPath || c.name) + "</div>" +
          (p.description ? ('<div class="small">' + escapeHtml(stripHtml(p.description)).slice(0,160) + (stripHtml(p.description).length>160 ? "‚Ä¶" : "") + "</div>") : "");

        left.appendChild(cb);
        left.appendChild(body);

        var right = document.createElement("div");
        right.style.display = "flex";
        right.style.gap = "8px";
        right.style.flexWrap = "wrap";

        var btn = document.createElement("button");
        btn.className = "btn";
        btn.type = "button";
        btn.textContent = "Haritada a√ß";
        btn.addEventListener("click", function(){
          window.open("https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(p.lat + "," + p.lng), "_blank");
        });
        right.appendChild(btn);

        card.appendChild(left);
        card.appendChild(right);
        listEl.appendChild(card);
      })(filtered[i]);
    }

    if(pts.length && !filtered.length){
      listEl.innerHTML = '<div style="color:var(--muted); font-size:12px; padding:10px">Arama kriterine uygun kayƒ±t yok.</div>';
    }
  }

  function renderItinerary(){
    itineraryEl.innerHTML = "";
    var c = activeCity();
    if(!c){
      itineraryEl.innerHTML = '<div style="color:var(--muted); font-size:12px;">√ñnce bir ≈üehir i√ße aktarƒ±n.</div>';
      return;
    }
    travelModeEl.value = c.travelMode || "walking";
    var selectedOrdered = selectedOrderedPoints(c);

    for(var i=0;i<selectedOrdered.length;i++){
      (function(p){
        var row = document.createElement("div");
        row.className = "itItem";

        var left = document.createElement("div");
        left.innerHTML = "<strong>" + escapeHtml(p.name) + "</strong>" +
          '<div style="color:var(--muted); font-size:12px; margin-top:3px;">' + escapeHtml(p.folderPath || c.name) + "</div>";

        var ctrls = document.createElement("div");
        ctrls.className = "itControls";

        var up = document.createElement("button");
        up.className = "iconBtn";
        up.type = "button";
        up.title = "Yukarƒ±";
        up.textContent = "‚Üë";
        up.addEventListener("click", function(){ move(p.id, -1); });

        var down = document.createElement("button");
        down.className = "iconBtn";
        down.type = "button";
        down.title = "A≈üaƒüƒ±";
        down.textContent = "‚Üì";
        down.addEventListener("click", function(){ move(p.id, +1); });

        var del = document.createElement("button");
        del.className = "iconBtn";
        del.type = "button";
        del.title = "√áƒ±kar";
        del.textContent = "‚úï";
        del.addEventListener("click", function(){ toggleSelect(p.id); });

        ctrls.appendChild(up); ctrls.appendChild(down); ctrls.appendChild(del);
        row.appendChild(left); row.appendChild(ctrls);
        itineraryEl.appendChild(row);
      })(selectedOrdered[i]);
    }

    btnOpenMaps.disabled = !(selectedOrdered.length >= 2);
    btnClearRoute.disabled = !(selectedOrdered.length >= 1);
    btnExportJson.disabled = !(selectedOrdered.length >= 1);
  }

  function renderStats(){
    var c = activeCity();
    if(!c){
      kpiKm.textContent = "-";
      kpiMin.textContent = "-";
      kpiSrc.textContent = "-";
      kpiStart.textContent = "-";
      statsMsg.textContent = "Km/Dk hesabƒ± i√ßin en az 2 nokta se√ßin.";
      legsEl.innerHTML = "";
      btnCompute.disabled = true;
      return;
    }
    var pts = selectedOrderedPoints(c);
    var canCompute = pts.length >= 2;
    btnCompute.disabled = !canCompute;
    if(!canCompute){
      kpiKm.textContent = "-";
      kpiMin.textContent = "-";
      kpiSrc.textContent = "-";
      kpiStart.textContent = "-";
      statsMsg.textContent = "Km/Dk hesabƒ± i√ßin en az 2 nokta se√ßin.";
      legsEl.innerHTML = "";
      return;
    }
    var s = c.lastStats;
    if(!s){
      kpiKm.textContent = "-";
      kpiMin.textContent = "-";
      kpiSrc.textContent = "-";
      kpiStart.textContent = "-";
      statsMsg.textContent = "Hazƒ±r. ‚ÄúKm/Dk Hesapla‚Äù butonuna basƒ±n.";
      legsEl.innerHTML = "";
      return;
    }
    kpiKm.textContent = (s.totalKm || 0).toFixed(1);
    kpiMin.textContent = String(Math.round(s.totalMin || 0));
    kpiSrc.textContent = s.source || "-";
    kpiStart.textContent = s.startName || "-";
    statsMsg.textContent = "Son hesap: " + (new Date(s.computedAt)).toLocaleString("tr-TR") + " ‚Äî Mod: " + s.mode;
    legsEl.innerHTML = "";
    for(var i=0;i<(s.legs||[]).length;i++){
      var lg = s.legs[i];
      var div = document.createElement("div");
      div.className = "leg";
      div.innerHTML = '<div class="t">' + escapeHtml(lg.from) + " ‚Üí " + escapeHtml(lg.to) + "</div>" +
        "<div>" + lg.km.toFixed(1) + " km ‚Ä¢ " + Math.round(lg.min) + " dk ‚Ä¢ <span style='opacity:.85'>" + escapeHtml(lg.src) + "</span></div>";
      legsEl.appendChild(div);
    }
  }

  function renderAll(){
    if(!state.activeCityId && state.cities.length) state.activeCityId = state.cities[0].id;
    save();
    renderCitySelect();
    renderBadge();
    renderList();
    renderItinerary();
    renderStats();

    var c = activeCity();
    var hasCity = !!c;
    btnAppendCity.setAttribute("aria-disabled", hasCity ? "false" : "true");
    btnRenameCity.disabled = !hasCity;
    btnDeleteCity.disabled = !hasCity;
    search.disabled = !hasCity;
  }

  // View switcher
  function setView(mode){
    if(mode === "right"){
      document.body.classList.remove("show-left");
      document.body.classList.add("show-right");
      segLeft.classList.remove("active");
      segRight.classList.add("active");
    }else{
      document.body.classList.remove("show-right");
      document.body.classList.add("show-left");
      segRight.classList.remove("active");
      segLeft.classList.add("active");
    }
  }

  // Events
  segLeft.addEventListener("click", function(){ setView("left"); });
  segRight.addEventListener("click", function(){ setView("right"); });

  btnResetAll.addEventListener("click", resetAll);
  btnRenameCity.addEventListener("click", renameActiveCity);
  btnDeleteCity.addEventListener("click", deleteActiveCity);

  citySelect.addEventListener("change", function(){
    state.activeCityId = citySelect.value || null;
    save();
    search.value = "";
    renderAll();
  });
  search.addEventListener("input", function(){ renderAll(); });

  fileNew.addEventListener("change", function(e){
    var files = e.target.files;
    e.target.value = "";
    if(files && files.length) handleMultiNew(files);
  });

  fileAppend.addEventListener("change", function(e){
    var files = e.target.files;
    e.target.value = "";
    if(files && files.length) handleMultiAppend(files);
  });

  travelModeEl.addEventListener("change", function(){
    var c = activeCity(); if(!c) return;
    updateActiveCity(function(city){
      city.travelMode = travelModeEl.value;
      city.updatedAt = nowIso();
      city.lastStats = null;
      return city;
    });
    renderAll();
  });

  btnClearRoute.addEventListener("click", clearRoute);
  btnExportJson.addEventListener("click", exportJson);
  btnOpenMaps.addEventListener("click", openMaps);
  btnCompute.addEventListener("click", computeRouteStats);

  // Modal events
  btnPasteKml.addEventListener("click", function(){ showModal(); });
  btnModalClose.addEventListener("click", function(){ hideModal(); });
  modalOverlay.addEventListener("click", function(e){ if(e.target === modalOverlay) hideModal(); });

  btnPasteSample.addEventListener("click", function(){
    var sample = '<?xml version="1.0" encoding="UTF-8"?>\n' +
      '<kml xmlns="http://www.opengis.net/kml/2.2">\n' +
      '  <Document>\n' +
      '    <Placemark><name>√ñrnek Nokta 1</name><Point><coordinates>28.9784,41.0082,0</coordinates></Point></Placemark>\n' +
      '    <Placemark><name>√ñrnek Nokta 2</name><Point><coordinates>28.9870,41.0150,0</coordinates></Point></Placemark>\n' +
      '  </Document>\n' +
      '</kml>';
    kmlTextEl.value = sample;
    setModalStatus("√ñrnek KML eklendi.");
  });

  btnFetchUrl.addEventListener("click", function(){
    var url = (kmlUrlEl.value || "").trim();
    if(!url){ setModalStatus("L√ºtfen bir URL girin."); return; }
    setModalStatus("URL‚Äôden getiriliyor...");
    btnFetchUrl.disabled = true;
    fetchTextFromUrl(url).then(function(t){
      kmlTextEl.value = t;
      setModalStatus("URL‚Äôden alƒ±ndƒ±. ≈ûimdi ‚Äúƒ∞√ße aktar‚Äù diyebilirsiniz.");
    }).catch(function(){
      setModalStatus("URL alƒ±namadƒ±. Not: Bazƒ± siteler CORS nedeniyle engeller. Ba≈üka kaynak deneyin.");
    }).finally(function(){
      btnFetchUrl.disabled = false;
    });
  });

  btnImportText.addEventListener("click", function(){
    var target = kmlTargetEl.value || "new";
    var name = (kmlCityNameEl.value || "").trim();
    setModalStatus("ƒ∞√ße aktarƒ±lƒ±yor...");
    btnImportText.disabled = true;
    try{
      var res = importFromKmlText(kmlTextEl.value, name, target);
      hideModal();
      search.value = "";
      renderAll();
      alert(res.mode === "append" ? ("Aktif ≈üehre eklendi (" + res.count + ").") : ("Yeni ≈üehir eklendi: " + res.name + " (" + res.count + ")."));
    }catch(err){
      setModalStatus(err && err.message ? err.message : String(err));
    }
    btnImportText.disabled = false;
  });

  // Init
  load();
  renderAll();
})();
</script>

<script>
  (function(){
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function(){
        navigator.serviceWorker.register("./sw.js").catch(function(){ /* ignore */ });
      });
    }
  })();
</script>

</body>
</html>
